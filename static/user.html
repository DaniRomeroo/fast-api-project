<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-slate-200 font-sans min-h-screen">

<!-- Navbar -->
<nav class="bg-slate-800 border-b border-slate-700 shadow-lg">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-user text-emerald-400 text-2xl"></i>
            <h1 class="text-xl font-bold text-white">User Panel</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="goBack()" class="bg-blue-500/20 hover:bg-blue-500/40 text-blue-400 py-2 px-4 rounded">
                Back to Dashboard
            </button>
            <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/40 text-red-400 py-2 px-4 rounded">
                Logout
            </button>
        </div>
    </div>
</nav>

<main class="max-w-6xl mx-auto px-4 py-10">

<!-- User Info -->
<section class="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg mb-10">
    <div>
        <div class="flex items-center justify-between mb-5">
            <h2 class="text-base font-bold text-emerald-400 flex items-center gap-1">
                <i class="fa-solid fa-user-circle"></i> User Info
            </h2>
            <button onclick="openUserModal()" class="text-emerald-400 hover:text-emerald-300">
                <i class="fa-solid fa-pencil"></i>
            </button>
        </div>
        <div class="flex flex-wrap gap-4 text-base text-white">
            <span><strong>Id:</strong> <span id="user_id">Loading...</span></span>
            <span><strong>Username:</strong> <span id="user_username">Loading...</span></span>
            <span><strong>Name:</strong> <span id="user_fullname">Loading...</span></span>
            <span><strong>Email:</strong> <span id="user_email">Loading...</span></span>
            <span><strong>User Active:</strong> <span id="user_active">Loading...</span></span>
            <span><strong>Role:</strong> <span id="user_role">Loading...</span></span>
        </div>
    </div>
</section>

<h2 class="text-2xl font-bold mb-6">Stock Analysis</h2>

<!-- Stock selector -->
<section class="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg mb-10">
    <div class="flex gap-3 mb-4">
        <input
            type="text"
            id="symbolInput"
            placeholder="Enter ticker, e.g. AAPL"
            class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white w-full focus:outline-none focus:ring-2 focus:ring-yellow-400"
        />
        <button
            onclick="fetchAnalysis()"
            class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded"
        >
            Analyze
        </button>
    </div>

    <!-- Supported stocks cheat sheet -->
    <div class="mt-4">
        <p class="text-sm text-slate-400 mb-2">
            Supported stocks (click to autofill):
        </p>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
            <button onclick="setSymbol('AAPL')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>AAPL</strong><br>
                <span class="text-slate-400">Apple</span>
            </button>

            <button onclick="setSymbol('MSFT')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>MSFT</strong><br>
                <span class="text-slate-400">Microsoft</span>
            </button>

            <button onclick="setSymbol('GOOGL')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>GOOGL</strong><br>
                <span class="text-slate-400">Alphabet</span>
            </button>

            <button onclick="setSymbol('ORCL')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>ORCL</strong><br>
                <span class="text-slate-400">Oracle</span>
            </button>
            <button onclick="setSymbol('INTC')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>INTC</strong><br>
                <span class="text-slate-400">Intel</span>
            </button>
            <button onclick="setSymbol('NVDA')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>NVDA</strong><br>
                <span class="text-slate-400">Nvidia</span>
            </button>
            <button onclick="setSymbol('META')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>META</strong><br>
                <span class="text-slate-400">Meta</span>
            </button>
            <button onclick="setSymbol('AMZN')" class="bg-slate-900 hover:bg-slate-700 border border-slate-700 rounded px-3 py-2 text-left">
                <strong>AMZN</strong><br>
                <span class="text-slate-400">Amazon</span>
            </button>
        </div>
    </div>

    <pre id="analysisOutput" class="bg-slate-900 p-4 rounded text-sm overflow-x-auto border border-slate-700 mt-6"> Waiting...</pre>

    <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-8">

        <div class="bg-slate-900 border border-slate-700 rounded p-4">
            <h3 class="font-bold mb-3">Price Evolution</h3>
            <canvas id="priceChart"></canvas>
        </div>

        <div class="bg-slate-900 border border-slate-700 rounded p-4">
            <h3 class="font-bold mb-3">Social Mentions (ApeWisdom â€“ 24h)</h3>
            <canvas id="mentionsChart"></canvas>
        </div>

    </div>

</section>
<div id="userModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
    <div class="bg-slate-800 p-8 rounded-lg w-[28rem] max-w-[90%] min-h-[24rem] border border-slate-700">
        <h3 class="text-xl font-bold mb-4">User details</h3>
        <div id="userDetails" class="text-base bg-slate-900 p-3 rounded text-white flex flex-col gap-3">
            <div class="flex items-center gap-2">
                <strong class="w-24">Id:</strong>
                <span id="modal_user_id"></span>
            </div>
            <div class="flex items-center gap-2">
                <strong class="w-24">Username:</strong>
                <span id="modal_user_username"></span>
            </div>
            <div class="flex items-center gap-2">
                <strong class="w-24">Full Name:</strong>
                <input type="text" id="user_fullname_input" class="flex-1 p-1 rounded border border-slate-700 text-white bg-transparent"/>
                <i class="fa-solid fa-pencil text-xs text-yellow-400"></i>
            </div>
            <div class="flex items-center gap-2">
                <strong class="w-24">Email:</strong>
                <input type="email" id="user_email_input" class="flex-1 p-1 rounded border border-slate-700 text-white bg-transparent"/>
                <i class="fa-solid fa-pencil text-xs text-yellow-400"></i>
            </div>
            <div class="flex items-center gap-2">
                <strong class="w-24">Active:</strong>
                <span id="modal_user_active"></span>
            </div>
            <div class="flex items-center gap-2">
                <strong class="w-24">Role:</strong>
                <span id="modal_user_role"></span>
            </div>
        </div>

        <div class="mt-4 flex gap-2">
            <button onclick="updateUser()" class="w-1/2 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded">
                Save
            </button>
            <button onclick="closeModal()" class="w-1/2 bg-red-600 hover:bg-red-700 text-white py-2 rounded">
                Cancel
            </button>
        </div>
    </div>
</div>
</main>

<script>
const token = localStorage.getItem('access_token');

let priceChart = null;
let mentionsChart = null;

async function fetchAnalysis() {
    const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();

    if (!symbol) {
        alert('Please enter a ticker symbol.');
        return;
    }

    const output = document.getElementById('analysisOutput');
    output.innerText = 'Fetching analysis...';

    try {
        const res = await fetch(`/analyze/${symbol}`, {
            headers: {
                "Authorization": `Bearer ${token}`
            }
        });

        if (!res.ok) {
            throw new Error('Analysis not available for this symbol');
        }

        const data = await res.json();

        output.innerText = `
Symbol: ${symbol}

Last Price (TwelveData): ${data.td_last_price ?? "-"}
Mentions (ApeWisdom):   ${data.aw_last_mentions ?? "-"}

Price Trend:            ${data.price_trend ?? "-"}
Social Interest:        ${data.social_interest ?? "-"}

TD Records:             ${data.td_count ?? "-"}
AW Records:             ${data.aw_count ?? "-"}

Explanation:
${data.summary ?? "No summary available"}
        `;

        // ---- PRICE CHART ----
        if (priceChart) priceChart.destroy();
        priceChart = new Chart(
            document.getElementById('priceChart'),
            {
                type: 'line',
                data: {
                    labels: data.td_prices_series.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Price',
                        data: data.td_prices_series,
                        borderWidth: 2,
                        tension: 0.3
                    }]
                }
            }
        );

        // ---- MENTIONS CHART ----
        if (mentionsChart) mentionsChart.destroy();
        mentionsChart = new Chart(
            document.getElementById('mentionsChart'),
            {
                type: 'bar',
                data: {
                    labels: data.aw_mentions_series.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Mentions',
                        data: data.aw_mentions_series
                    }]
                }
            }
        );

    } catch (err) {
        output.innerText = `Error: ${err.message}`;
    }
}

function goBack() {
    window.location.href = '/';
}

function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('user_id');
    localStorage.removeItem('role');
    window.location.href = '/';
}

function setSymbol(symbol) {
    document.getElementById('symbolInput').value = symbol;
}
</script>
<script>
async function loadUserProfile() {
    try {
        const res = await fetch("/users/me", {
            headers: { "Authorization": `Bearer ${localStorage.getItem("access_token")}` }
        });
        if (!res.ok) throw new Error("Failed to load user info");

        const data = await res.json();
        document.getElementById("user_id").innerText = data._id ?? "-";
        document.getElementById("user_username").innerText = data.username ?? "-";
        document.getElementById("user_fullname").innerText = data.full_name ?? "-";
        document.getElementById("user_email").innerText = data.email ?? "-";
        document.getElementById("user_active").innerText = data.is_active ? 'Yes' : 'No' ?? "-";
        document.getElementById("user_role").innerText = data.role ?? "-";
    } catch (err) {
        console.error(err);
    }
}

async function openUserModal() {
    const userId = document.getElementById('user_id').innerText;

    try {
        const res = await fetch('/users/' + userId, {
            method: 'GET',
            headers: {'Authorization': `Bearer ${token}`}
        });
        if (!res.ok) throw new Error('Failed to load user');

        const user = await res.json();
        
        document.getElementById('modal_user_id').innerText = user._id;
        document.getElementById('modal_user_username').innerText = user.username;
        document.getElementById('user_fullname_input').value = user.full_name || '';
        document.getElementById('user_email_input').value = user.email || '';
        document.getElementById('modal_user_active').innerText = user.is_active ? 'Yes' : 'No';
        document.getElementById('modal_user_role').innerText = user.role || 'role_user';

        document.getElementById('userModal').classList.remove('hidden');
    } catch(err){
        alert(err.message);
    }
}

async function updateUser(){
    const userId = document.getElementById('user_id').innerText;
    const fullName = document.getElementById('user_fullname_input').value;
    const email = document.getElementById('user_email_input').value;

    try {
        const res = await fetch('/users/' + userId, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ full_name: fullName, email: email })
        });

        if (!res.ok) throw new Error('Failed to update user');
        closeModal();
        loadUserProfile();
    } catch(err){
        alert(err.message);
    }
}

function closeModal(){
    document.getElementById('userModal').classList.add('hidden');
}


loadUserProfile();
</script>

</body>
</html>
